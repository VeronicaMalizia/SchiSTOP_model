---
title: "Regulating mechanisms for Schistosomiasis transmission"
author: "Veronica Malizia"
date: "07-03-2023"
output:
  html_document: default
  pdf_document: default
---

```{r setup, include=FALSE}
rm(list = ls())

.libPaths(c("C:/Program Files/R/R-4.1.2/library",.libPaths()))

knitr::opts_chunk$set(echo = TRUE, warning=FALSE, message = FALSE,
                      fig.width=12, fig.height=10)
```

```{r setting, echo=FALSE, include=FALSE}

library(tidyverse)
library(readxl)
library(ggridges)
library(patchwork)
library(egg)
library(rstudioapi)
library(scales)

`%!in%` <- Negate(`%in%`)
geom_mean <- function(x){exp(mean(log(x)))}
ci <- function(x){quantile(x, probs=c(0.025, 0.975), na.rm = T)}
################

#Set folder
source.dir <- dirname(getActiveDocumentContext()$path)
  #"C:/Users/Z541213/Documents/Project/Model/Schisto_model"
setwd(source.dir)

#Load parameters
source("02_Parameters_Smansoni.R")
#Setting scenario
source("Setting_simulation_scenario.R")

```

# Simulation setting

```{r parameters, echo=FALSE, results='asis'}
library(knitr)
kable(caption = "Simulation setting and transmission parameters",
      read_excel(paste("Zetas_", exposure, "_func.xlsx", sep = "")) %>%
        filter(Endemicity == endem) %>%
        select(Endemicity,	Immunity, Snails,	DDF,	Zeta_grid_search,	Kw,	`Transmission on snails`) %>%
        mutate(`Transmission on snails` = format(`Transmission on snails`, scientific = T))
      )

```

# Simulation results

```{r loading population data, echo=FALSE}
#Load population output
#####Load collated results and produce multi-panel plots
pop.output.dir <- file.path(source.dir, "Output/Population")
res <- readRDS(file.path(pop.output.dir, 
               paste(setting, ".RDS", sep = "")))

# if(endem=="High" | endem=="Moderate"){
#   res <- res[- which(res$Immunity=="Absent" & res$Snails=="Absent" & res$DDF=="Absent"),]
# }
#Computing faded-out runs at pre-control ( soon before MDA)
faided <- res %>%
  filter(time==(parms$mda$start-1)*12) %>%
  group_by(Immunity, Snails, DDF) %>%
  summarise(faided_seed = length(which(eggs_prev_SAC==0))*100/seeds)
n_faided <- length(which(faided$faided_seed>0))

#Computing runs that get eliminated after MDA (check 50 ys after MDA):
eliminated <- res %>%
  filter(time==(parms$mda$end+50)*12) %>%
  group_by(Immunity, Snails, DDF) %>%
  summarise(eliminated_seed = length(which(eggs_prev_SAC==0))*100/seeds,
            ephp_seed = length(which(Heggs_prev<=0.01))*100/seeds)

#Average by seed
if(n_faided>0){
  res <- res[- which(res$time==(parms$mda$start-1)*12 & res$eggs_prev_SAC==0), ]
}
  
data_avg <- res %>%
  group_by(time, Immunity, Snails, DDF) %>%
  summarise(eggs_prev_SAC = mean(eggs_prev_SAC),
            eggs_prev_tot = mean(eggs_prev),
            PHI = mean(Heggs_prev_SAC),
            miracidiae = mean(miracidiae),
            cercariae = mean(cercariae),
            snail_inf = mean(inf_snail),
            snail_exp = mean(exp_snail),
            snail_prev = mean(inf_snail/(susc_snail+inf_snail+exp_snail)))

```

# Prevalence timelines

```{r failed runs, echo=FALSE, results='asis'}
library(knitr)

#if(endem=="Low"){
  kable(caption = "Faded-out runs at pre-control",
        faided %>%
          mutate(faided_seed = paste(faided_seed, "%", sep = " "))
        )


kable(caption = "Eliminated runs after 10 ys MDA to SAC",
      eliminated %>%
          mutate(eliminated_seed = paste(eliminated_seed, "%", sep = " "),
                 ephp_seed = paste(ephp_seed, "%", sep = " "))
      )
#}
```

<!-- ## Prevalence of any infection in school-aged-children (SAC) -->

<!-- Solid lines show prevalence of infection in SAC. Dashed lines show the underlying prevalence of infection on snails (shedding). -->

<!-- ```{r SAC prev, echo=FALSE} -->


<!-- Fig <- ggplot(data=data_avg, aes(x=time/12)) + -->
<!--   geom_line(data = res, aes(y=eggs_prev_SAC*100, -->
<!--                             group = interaction(DDF, seed), -->
<!--                             colour = DDF), alpha = 0.01) + -->
<!--   geom_line(aes(y=eggs_prev_SAC*100, colour = DDF), alpha = 3) + -->
<!--   #geom_line(aes(y=PHI*100, colour = DDF), linetype = "longdash") + -->
<!--   # geom_segment(data = prev_endPC, -->
<!--   #              aes(x = 0, y = eggs_prev_SAC*100, xend = parms$mda$end, yend = eggs_prev_SAC*100, colour = DDF), -->
<!--   #              linetype = "dashed") + -->
<!--   labs(title = paste(endem, "endemicity setting", sep = " ")) + -->
<!--   facet_grid(Snails ~ Immunity, labeller = labeller(.rows = label_both, .cols = label_both)) + -->
<!--   scale_y_continuous(name = "Prevalence of infection in SAC (%) \n", -->
<!--                      breaks = seq(0, 100, 20), -->
<!--                      limits = c(0, 100), -->
<!--                      expand = c(0, 0)) + -->
<!--   scale_x_continuous(name = "\n Time [Years from last round of PC]", -->
<!--                      breaks = seq(parms$mda$start-10, parms$mda$end+50, 10), -->
<!--                      labels = seq(-20, 50, 10), -->
<!--                      #limits = c(0, 1200), -->
<!--                      expand = c(0, 0)) + -->
<!--   coord_cartesian(xlim=c(parms$mda$start-10, parms$mda$end+50)) + -->
<!--   expand_limits(x = 0,y = 0) + -->
<!--   theme_bw() + -->
<!--   theme(legend.position="bottom", -->
<!--         #axis.text.x = element_text(angle = 45, vjust = 0.5, hjust=0.5), -->
<!--         plot.margin = margin(5, 10, 0, 10, "pt"), -->
<!--         panel.spacing = unit(1.5, "lines"))  -->

<!-- # tiff("Plots/Modeling_scenarios/PrevalenceSAC.tif", width=10, height=9, units = "in", res = 300) -->
<!-- Fig  -->
<!-- # dev.off() -->
<!-- ``` -->

<!-- <!-- ## Zoom on MDA rounds --> -->

<!-- <!-- Solid lines show prevalence of infection in SAC. Dashed lines show the underlying prevalence of infection on snails (shedding). --> -->

<!-- <!-- ```{r SAC prevalence MDA, echo=FALSE} --> -->

<!-- <!-- #tiff("Plots/Modeling_scenarios/PrevalenceSAC_MDA.tif", width=10, height=9, units = "in", res = 300) --> -->

<!-- <!-- Fig +  --> -->

<!-- <!--   # geom_text(data=zetas, aes(x=170, y=80, label=my_tag),  --> -->

<!-- <!--   #           size=3) + --> -->

<!-- <!--   coord_cartesian(xlim=c(140, 170))  --> -->

<!-- <!-- #dev.off() --> -->

<!-- <!-- ``` --> -->

<!-- ## Prevalence of heavy intensity infections in SAC -->

<!-- ```{r heavy prev SAC, echo=FALSE} -->

<!-- Fig2 <- ggplot(data=data_avg, aes(x=time/12)) + -->
<!--   geom_line(aes(y=PHI*100, colour = DDF)) + -->
<!--   labs(title = paste(endem, "endemicity setting", sep = " ")) + -->
<!--   facet_grid(Snails ~ Immunity, labeller = labeller(.rows = label_both, .cols = label_both)) + -->
<!--   # geom_text(data=text, aes(x=200, y=80, label=my_tag),  -->
<!--   #           size=3) + -->
<!--   scale_y_continuous(name = "Prevalence of heavy infections (%) \n", -->
<!--                      breaks = seq(0, 100, 5), #1 l - 2 m - 5 h -->
<!--                      limits = c(0, 30), #2 l - 10 m - 30 h -->
<!--                      expand = c(0, 0)) + -->
<!--   scale_x_continuous(name = "\n Time [Years from last round of PC]", -->
<!--                      breaks = seq(parms$mda$start-10, parms$mda$end+50, 10), -->
<!--                      labels = seq(-20, 50, 10), -->
<!--                      #limits = c(0, 1200), -->
<!--                      expand = c(0, 0)) + -->
<!--   coord_cartesian(xlim=c(parms$mda$start-10, parms$mda$end+50)) + -->
<!--   expand_limits(x = 0,y = 0) + -->
<!--   theme_bw() + -->
<!--   theme(legend.position="bottom", -->
<!--         plot.margin = margin(5, 10, 0, 10, "pt"), -->
<!--         panel.spacing = unit(1, "lines"))  -->

<!-- #tiff("Plots/Modeling_scenarios/Prevalence_Heavy.tif", width=10, height=9, units = "in", res = 300) -->
<!-- Fig2  -->
<!-- #dev.off() -->
<!-- ``` -->

<!-- <!-- ## Check: ratio of miracidiae over cercariae in the environment --> -->

<!-- <!-- ```{r mirac and cerc, echo=FALSE} --> -->

<!-- <!-- cercVSmirac <- ggplot(data_avg, aes(x=time/12)) + --> -->

<!-- <!--   geom_line(aes(y=miracidiae/cercariae, colour = DDF), alpha=0.5) + --> -->

<!-- <!--   facet_grid(Snails ~ Immunity, labeller = labeller(.rows = label_both, .cols = label_both), scales = "free") + --> -->

<!-- <!--   scale_y_continuous(name = "Ratio miracidiae / cercariae", --> -->

<!-- <!--                      expand = c(0, 0)) + --> -->

<!-- <!--   scale_x_continuous(name = "Time [years]", --> -->

<!-- <!--                      expand = c(0, 0)) + --> -->

<!-- <!--   expand_limits(x = 0,y = 0) --> -->

<!-- <!-- cercVSmirac --> -->

<!-- <!-- ``` --> -->

<!-- # Individual-level results -->

<!-- ```{r loading individual data, echo=FALSE, include=FALSE} -->

<!-- #Load individual output -->
<!-- #Collate results by seeds -->
<!-- ind.output.dir <- file.path(source.dir, paste("Output/Individual/", setting, sep = ""))  -->

<!-- data_all <- list.files(path = ind.output.dir,  # Identify all output CSV files -->
<!--                        pattern = "^Ind_out_seed", full.names = TRUE) %>%  -->
<!--   lapply(readRDS) %>%              # Store all files in list -->
<!--   #lapply(read_csv, show_col_types = F) %>% -->
<!--   bind_rows %>% -->
<!--   filter(time == parms$mda$start-9 | time == parms$mda$end+1) #In the individual output, time is already in years -->


<!-- # Combine data sets into one -->
<!-- #Aggregate by age groups -->
<!-- #Filter one year of interest -->
<!-- #unique(data_all$time) #individual output contains time in years -->
<!-- #years <- c(81, 101, 151, 181) #c(51, 81, 101, 151, 161, 171, 181, 191) -->
<!-- # age_out <- data_all %>% -->
<!-- #   #filter(seed %!in% dead.seeds) %>% -->
<!-- #   mutate(age_group = case_when(age<=1 ~ "0_1", -->
<!-- #                                age>1 & age<=5 ~ "1_5", -->
<!-- #                                age>5 & age<=15 ~ "5_15", -->
<!-- #                                age>15 & age<=30 ~ "15_30", -->
<!-- #                                age>30 & age<=40 ~ "30_40", -->
<!-- #                                age>40 ~ "40_90")) %>%  -->
<!-- #   group_by(seed, time, age_group, Immunity, Snails, DDF) %>% #sex not for now -->
<!-- #   summarise(epg = mean(ec*24), #geom_mean(ec*24+1), #means over individuals of that age group -->
<!-- #             wp = mean(tot_wp), -->
<!-- #             dwp = mean(cum_dwp),  -->
<!-- #             rate = mean(rate)) -->


<!-- age_out <- data_all %>%  -->
<!--   group_by(time, Immunity, Snails, DDF) %>% -->
<!--   mutate(age_group = cut_number(age, n = 14)) %>% -->
<!--   group_by(seed, time, age_group, Immunity, Snails, DDF) %>% #sex not for now -->
<!--   summarise(avg_age_group = mean(age), -->
<!--             epg = mean(ec*24), #geom_mean(ec*24+1), #means over individuals of that age group -->
<!--             wp = mean(tot_wp), -->
<!--             dwp = mean(cum_dwp),  -->
<!--             rate = mean(rate)) -->

<!-- # age_out$age_group <- factor(age_out$age_group, levels = c("0_1", -->
<!-- #                                                           "1_5", -->
<!-- #                                                           "5_15", -->
<!-- #                                                           "15_30", -->
<!-- #                                                           "30_40", -->
<!-- #                                                           "40_90")) -->
<!-- age_out$time <- factor(as.factor(age_out$time),  -->
<!--                        levels = c(as.character(parms$mda$start-9), as.character(parms$mda$end+1)),  -->
<!--                        labels = c("Pre control",  "Post control")) -->

<!-- # saveRDS(age_out, file = file.path(ind.output.dir, "Avg_individual_output_pre&postmda.RDS")) -->

<!-- #Average over seeds -->
<!-- data_toplot <- age_out %>% -->
<!--   #filter(!(Immunity == "Absent" & Snails== "Absent" & DDF== "Absent")) %>% -->
<!--   group_by(age_group, time, Immunity, Snails, DDF) %>% -->
<!--   summarise(avg_age_group = mean(avg_age_group), -->
<!--             epg_mean = mean(epg), -->
<!--             epg_lo = ci(epg)[1], -->
<!--             epg_hi = ci(epg)[2], -->
<!--             wp_mean = mean(wp), -->
<!--             wp_lo = ci(wp)[1], -->
<!--             wp_hi = ci(wp)[2], -->
<!--             dwp_mean = mean(dwp), -->
<!--             dwp_lo = ci(dwp)[1], -->
<!--             dwp_hi = ci(dwp)[2], -->
<!--             rate_mean = mean(rate), -->
<!--             rate_lo = ci(rate)[1], -->
<!--             rate_hi = ci(rate)[2]) -->
<!-- ``` -->

<!-- ```{r plot functions, echo=FALSE} -->
<!-- #Mean intensity -->
<!-- eggs <- ggplot(filter(data_toplot, DDF=="Mild"),  -->
<!--          aes(x=avg_age_group, y=epg_mean, group = interaction(DDF, Immunity)))+ -->
<!--   #geom_pointrange(aes(ymin=epg_lo, ymax=epg_hi, colour = DDF, shape = Immunity)) + -->
<!--   geom_line(#data = filter(data_toplot, DDF=="Mild"), -->
<!--             aes(colour = DDF, linetype = Immunity), size = 1) + -->
<!--   #labs(title = paste(endem, "endemicity setting", sep = " ")) + -->
<!--   facet_grid(time ~ Snails, labeller = labeller(.rows = label_both, .cols = label_both)) + #, scales = "free_y") + -->
<!--   scale_y_continuous(name = "Egg counts (epg) \n", -->
<!--                 #breaks = seq(0, 10000, 200), -->
<!--                 #limits = c(0.5, 8000), #3000 l-m 8000 high -->
<!--                 expand = c(0, 0)) + -->
<!--   scale_x_continuous(name = "\n Age [years]", -->
<!--                      breaks = seq(0, 80, 10), -->
<!--                      limits = c(0, 70), -->
<!--                      expand = c(0, 0)) + -->
<!--   expand_limits(x = 0,y = 0) + -->
<!--   guides(shape = "none") + -->
<!--   scale_color_manual(values = c("Mild" = hue_pal()(3)[2])) + -->
<!--   scale_linetype_manual(values = c("Absent" = "solid", "Mild" = "dotted", "Strong" = "dashed")) + -->
<!--   theme_bw() + -->
<!--   theme(legend.position="bottom", -->
<!--         plot.margin = margin(5, 10, 0, 10, "pt"), -->
<!--         panel.spacing = unit(1, "lines"))  -->

<!-- # tiff("Plots/Modeling_scenarios/Age profiles/Eggs.tif", width=10, height=9, units = "in", res = 300) -->
<!-- # eggs -->
<!-- # dev.off() -->

<!-- #Parasite establishment rate -->
<!-- rate <- ggplot(data_toplot, aes(x=avg_age_group, y=rate_mean, group = interaction(DDF, time)))+ -->
<!--   geom_pointrange(aes(ymin=rate_lo, ymax=rate_hi, colour = DDF)) + -->
<!--   geom_line(aes(colour = DDF, linetype = time)) + -->
<!--   labs(title = paste(endem, "endemicity setting", sep = " ")) + -->
<!--   facet_grid(Snails ~ Immunity, labeller = labeller(.rows = label_both, .cols = label_both)) + -->
<!--   scale_y_continuous(name = "Parasite establishment rate \n", -->
<!--                      #breaks = seq(0, 20, 2), -->
<!--                      #limits = c(0.5, 80), #20 l-m 80 high -->
<!--                      expand = c(0, 0)) + -->
<!--   scale_x_continuous(name = "\n Age [years]", -->
<!--                      breaks = seq(0, 80, 10), -->
<!--                      limits = c(0, 70), -->
<!--                      expand = c(0, 0)) + -->
<!--   expand_limits(x = 0,y = 0) + -->
<!--   theme_bw() + -->
<!--   theme(#axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1), -->
<!--     legend.position="bottom", -->
<!--     plot.margin = margin(5, 10, 0, 10, "pt"), -->
<!--     panel.spacing = unit(1, "lines"))  -->

<!-- # tiff("Plots/Modeling_scenarios/Age profiles/Rate.tif", width=10, height=9, units = "in", res = 300) -->
<!-- # rate -->
<!-- # dev.off() -->

<!-- #Worms -->
<!-- worms <- ggplot(data_toplot, aes(x=avg_age_group, y=wp_mean, group = interaction(DDF, time)))+ -->
<!--   geom_pointrange(aes(ymin=wp_lo, ymax=wp_hi, colour = DDF)) + -->
<!--   geom_line(aes(colour = DDF, linetype = time)) + -->
<!--   labs(title = paste(endem, "endemicity setting", sep = " ")) + -->
<!--   facet_grid(Snails ~ Immunity, labeller = labeller(.rows = label_both, .cols = label_both)) + #, scales = "free_y") + -->
<!--   scale_y_continuous(name = "Worm load (pairs) \n", -->
<!--                 #breaks = seq(0, 10000, 200), -->
<!--                 #limits = c(0.5, 5000), #1000 l-m #5000 high -->
<!--                 expand = c(0, 0)) + -->
<!--   scale_x_continuous(name = "\n Age [years]", -->
<!--                      breaks = seq(0, 80, 10), -->
<!--                      limits = c(0, 70), -->
<!--                      expand = c(0, 0)) + -->
<!--   expand_limits(x = 0,y = 0) + -->
<!--   theme_bw() + -->
<!--   theme(#axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1), -->
<!--     legend.position="bottom", -->
<!--     plot.margin = margin(5, 10, 0, 10, "pt"), -->
<!--     panel.spacing = unit(1, "lines"))  -->

<!-- # tiff("Plots/Modeling_scenarios/Age profiles/Worms.tif", width=10, height=9, units = "in", res = 300) -->
<!-- # worms -->
<!-- # dev.off() -->

<!-- #Dead worm pairs -->
<!-- dead_worms <- ggplot(data_toplot, aes(x=avg_age_group, y=dwp_mean, group = interaction(DDF, time)))+ -->
<!--   geom_pointrange(aes(ymin=dwp_lo, ymax=dwp_hi, colour = DDF)) + -->
<!--   geom_line(aes(colour = DDF, linetype = time)) + -->
<!--   labs(title = paste(endem, "endemicity setting", sep = " ")) + -->
<!--   facet_grid(Snails ~ Immunity, labeller = labeller(.rows = label_both, .cols = label_both)) + -->
<!--   scale_y_continuous(name = "Cumulated dead worm (pairs) \n", -->
<!--                 #breaks = seq(0, 10000, 200), -->
<!--                 #limits = c(0.5, 1000), -->
<!--                 expand = c(0, 0)) + -->
<!--   scale_x_continuous(name = "\n Age [years]", -->
<!--                      breaks = seq(0, 80, 10), -->
<!--                      limits = c(0, 70), -->
<!--                      expand = c(0, 0)) + -->
<!--   expand_limits(x = 0,y = 0) + -->
<!--   theme_bw() + -->
<!--   theme(#axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1), -->
<!--     legend.position="bottom", -->
<!--     plot.margin = margin(5, 10, 0, 10, "pt"), -->
<!--     panel.spacing = unit(1, "lines"))  -->

<!-- # tiff("Plots/Modeling_scenarios/Age profiles/Dead_worms.tif", width=10, height=9, units = "in", res = 300) -->
<!-- # dead_worms -->
<!-- # dev.off() -->
<!-- ``` -->

<!-- ## Age-intensity profiles -->

<!-- ```{r age-intensity, echo=FALSE} -->
<!-- eggs -->
<!-- ``` -->

<!-- ## Check: worm distribution by age -->

<!-- ```{r worms, echo=FALSE} -->
<!-- worms -->
<!-- ``` -->

<!-- ## Check: parasite establishment rate -->

<!-- ```{r establishment rate, echo=FALSE} -->
<!-- rate -->
<!-- ``` -->

<!-- ## Check: cumulated dead worms by age -->

<!-- ```{r dead worms, echo=FALSE} -->
<!-- dead_worms -->
<!-- ``` -->

<!-- <!-- ## Average worm pairs and epg in the whole population --> -->

<!-- <!-- ```{r avg worms, echo=FALSE, results='asis'} --> -->

<!-- <!-- library(knitr) --> -->

<!-- <!-- kable(caption = "Population mean and 95%-CI of worm burdens and observed epg", --> -->

<!-- <!--       data_all %>% --> -->

<!-- <!--         filter(time == 131) %>% --> -->

<!-- <!--         #filter(seed %!in% dead.seeds) %>% --> -->

<!-- <!--         group_by(Immunity, Snails, DDF) %>% #sex not for now --> -->

<!-- <!--         summarise(wp_mean = mean(tot_wp), --> -->

<!-- <!--                   wp_lo = ci(tot_wp)[1], --> -->

<!-- <!--                   wp_hi = ci(tot_wp)[2], --> -->

<!-- <!--                   epg_mean = mean(ec*24), #geom_mean(ec*24+1), #means over individuals of that sex-age group --> -->

<!-- <!--                   epg_lo = ci(ec*24)[1], --> -->

<!-- <!--                   epg_hi = ci(ec*24)[2]) --> -->

<!-- <!-- ) --> -->

<!-- <!-- ``` --> -->
